"use strict";(self.webpackChunkharvester_docs=self.webpackChunkharvester_docs||[]).push([[4698],{3905:(e,t,a)=>{a.d(t,{Zo:()=>d,kt:()=>m});var r=a(67294);function n(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,r)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){n(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,r,n=function(e,t){if(null==e)return{};var a,r,n={},i=Object.keys(e);for(r=0;r<i.length;r++)a=i[r],t.indexOf(a)>=0||(n[a]=e[a]);return n}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)a=i[r],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}var p=r.createContext({}),l=function(e){var t=r.useContext(p),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},d=function(e){var t=l(e.components);return r.createElement(p.Provider,{value:t},e.children)},u="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},h=r.forwardRef((function(e,t){var a=e.components,n=e.mdxType,i=e.originalType,p=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),u=l(a),h=n,m=u["".concat(p,".").concat(h)]||u[h]||c[h]||i;return a?r.createElement(m,o(o({ref:t},d),{},{components:a})):r.createElement(m,o({ref:t},d))}));function m(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var i=a.length,o=new Array(i);o[0]=h;var s={};for(var p in t)hasOwnProperty.call(t,p)&&(s[p]=t[p]);s.originalType=e,s[u]="string"==typeof e?e:n,o[1]=s;for(var l=2;l<i;l++)o[l]=a[l];return r.createElement.apply(null,o)}return r.createElement.apply(null,a)}h.displayName="MDXCreateElement"},71344:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>p,contentTitle:()=>o,default:()=>c,frontMatter:()=>i,metadata:()=>s,toc:()=>l});var r=a(87462),n=(a(67294),a(3905));const i={sidebar_position:2,sidebar_label:"Upgrade from v1.1.2 to v1.2.0",title:"Upgrade from v1.1.2 to v1.2.0"},o=void 0,s={unversionedId:"upgrade/v1-1-2-to-v1-2-0",id:"upgrade/v1-1-2-to-v1-2-0",title:"Upgrade from v1.1.2 to v1.2.0",description:"General information",source:"@site/docs/upgrade/v1-1-2-to-v1-2-0.md",sourceDirName:"upgrade",slug:"/upgrade/v1-1-2-to-v1-2-0",permalink:"/v1.2/upgrade/v1-1-2-to-v1-2-0",draft:!1,editUrl:"https://github.com/harvester/docs/edit/main/docs/upgrade/v1-1-2-to-v1-2-0.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2,sidebar_label:"Upgrade from v1.1.2 to v1.2.0",title:"Upgrade from v1.1.2 to v1.2.0"},sidebar:"docs",previous:{title:"Upgrading Harvester",permalink:"/v1.2/upgrade/index"},next:{title:"Upgrade from v1.1.0/v1.1.1 to v1.1.2",permalink:"/v1.2/upgrade/v1-1-to-v1-1-2"}},p={},l=[{value:"General information",id:"general-information",level:2},{value:"Known issues",id:"known-issues",level:2},{value:"1. An upgrade can&#39;t start and reports <code>&quot;validator.harvesterhci.io&quot; denied the request: managed chart rancher-monitoring is not ready, please wait for it to be ready</code>",id:"1-an-upgrade-cant-start-and-reports-validatorharvesterhciio-denied-the-request-managed-chart-rancher-monitoring-is-not-ready-please-wait-for-it-to-be-ready",level:3},{value:"2. An upgrade is stuck in <code>Creating Upgrade Repository</code>",id:"2-an-upgrade-is-stuck-in-creating-upgrade-repository",level:3},{value:"3. An upgrade is stuck when pre-draining a node",id:"3-an-upgrade-is-stuck-when-pre-draining-a-node",level:3},{value:"4. An upgrade is stuck in upgrading the first node: Job was active longer than the specified deadline",id:"4-an-upgrade-is-stuck-in-upgrading-the-first-node-job-was-active-longer-than-the-specified-deadline",level:3},{value:"5. An upgrade is stuck in the Pre-drained state",id:"5-an-upgrade-is-stuck-in-the-pre-drained-state",level:3}],d={toc:l},u="wrapper";function c(e){let{components:t,...i}=e;return(0,n.kt)(u,(0,r.Z)({},d,i,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("head",null,(0,n.kt)("link",{rel:"canonical",href:"https://docs.harvesterhci.io/v1.2/upgrade/v1-1-2-to-v1-2-0"})),(0,n.kt)("h2",{id:"general-information"},"General information"),(0,n.kt)("admonition",{type:"tip"},(0,n.kt)("p",{parentName:"admonition"},"Before you start an upgrade, you can run the pre-check script to make sure the cluster is in a stable state. For more details, please visit this ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/harvester/upgrade-helpers/tree/main/pre-check/v1.1.x"},"URL")," for the script.")),(0,n.kt)("p",null,"Once there is an upgradable version, the Harvester GUI Dashboard page will show an upgrade button. For more details, please refer to ",(0,n.kt)("a",{parentName:"p",href:"/v1.2/upgrade/index#start-an-upgrade"},"start an upgrade"),"."),(0,n.kt)("p",null,"For the air-gap env upgrade, please refer to ",(0,n.kt)("a",{parentName:"p",href:"/v1.2/upgrade/index#prepare-an-air-gapped-upgrade"},"prepare an air-gapped upgrade"),"."),(0,n.kt)("h2",{id:"known-issues"},"Known issues"),(0,n.kt)("hr",null),(0,n.kt)("h3",{id:"1-an-upgrade-cant-start-and-reports-validatorharvesterhciio-denied-the-request-managed-chart-rancher-monitoring-is-not-ready-please-wait-for-it-to-be-ready"},"1. An upgrade can't start and reports ",(0,n.kt)("inlineCode",{parentName:"h3"},'"validator.harvesterhci.io" denied the request: managed chart rancher-monitoring is not ready, please wait for it to be ready')),(0,n.kt)("p",null,"If a cluster is configured with a ",(0,n.kt)("strong",{parentName:"p"},"storage network"),", an upgrade can't start with the following message."),(0,n.kt)("p",null,(0,n.kt)("img",{src:a(71178).Z,width:"1722",height:"606"})),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Related issue:",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/harvester/harvester/issues/3839"},"[Doc] upgrade stuck while upgrading system service with alertmanager and prometheus")))),(0,n.kt)("li",{parentName:"ul"},"Workaround:",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/harvester/harvester/issues/3839#issuecomment-1534438192"},"https://github.com/harvester/harvester/issues/3839#issuecomment-1534438192"))))),(0,n.kt)("hr",null),(0,n.kt)("h3",{id:"2-an-upgrade-is-stuck-in-creating-upgrade-repository"},"2. An upgrade is stuck in ",(0,n.kt)("inlineCode",{parentName:"h3"},"Creating Upgrade Repository")),(0,n.kt)("p",null,"During an upgrade, ",(0,n.kt)("strong",{parentName:"p"},"Creating Upgrade Repository")," is stuck in the ",(0,n.kt)("strong",{parentName:"p"},"Pending")," state:"),(0,n.kt)("p",null,"  ",(0,n.kt)("img",{src:a(41273).Z,width:"1142",height:"286"})),(0,n.kt)("p",null,"Please perform the following steps to check if the cluster runs into the issue:"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Check the upgrade repository pod:"),(0,n.kt)("p",{parentName:"li"},(0,n.kt)("img",{src:a(16380).Z,width:"1375",height:"185"})),(0,n.kt)("p",{parentName:"li"},"If the ",(0,n.kt)("inlineCode",{parentName:"p"},"virt-launcher-upgrade-repo-hvst-<upgrade-name>")," pod stays in ",(0,n.kt)("inlineCode",{parentName:"p"},"ContainerCreating"),", your cluster might have run into this issue. In this case, proceed with step 2.")),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Check the upgrade repository volume in the Longhorn GUI."),(0,n.kt)("ol",{parentName:"li"},(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},(0,n.kt)("a",{parentName:"p",href:"/v1.2/troubleshooting/harvester#access-embedded-rancher-and-longhorn-dashboards"},"Go to Longhorn GUI"),".")),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Navigate to the ",(0,n.kt)("strong",{parentName:"p"},"Volume")," page.")),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Check the upgrade repository VM volume. It should be attached to a pod called ",(0,n.kt)("inlineCode",{parentName:"p"},"virt-launcher-upgrade-repo-hvst-<upgrade-name>"),". If one of the volume's replicas stays in ",(0,n.kt)("inlineCode",{parentName:"p"},"Stopped")," (gray color), the cluster is running into the issue."),(0,n.kt)("p",{parentName:"li"},(0,n.kt)("img",{src:a(46479).Z,width:"1883",height:"588"})))))),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Related issue:",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/harvester/harvester/issues/4246"},"[BUG] upgrade stuck on create upgrade VM")))),(0,n.kt)("li",{parentName:"ul"},"Workaround:",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"Delete the ",(0,n.kt)("inlineCode",{parentName:"li"},"Stopped")," replica from Longhorn GUI. Or,"),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"/v1.2/upgrade/troubleshooting#start-over-an-upgrade"},"Start over the upgrade"),".")))),(0,n.kt)("hr",null),(0,n.kt)("h3",{id:"3-an-upgrade-is-stuck-when-pre-draining-a-node"},"3. An upgrade is stuck when pre-draining a node"),(0,n.kt)("p",null,'Starting from v1.1.0, Harvester will wait for all volumes to become healthy (when node count >= 3) before upgrading a node. Generally, you can check volumes\' health if an upgrade is stuck in the "pre-draining" state.'),(0,n.kt)("p",null,"Visit ",(0,n.kt)("a",{parentName:"p",href:"/v1.2/troubleshooting/harvester#access-embedded-rancher-and-longhorn-dashboards"},'"Access Embedded Longhorn"')," to see how to access the embedded Longhorn GUI."),(0,n.kt)("p",null,"You can also check the pre-drain job logs. Please refer to ",(0,n.kt)("a",{parentName:"p",href:"/v1.2/upgrade/troubleshooting#phase-4-upgrade-nodes"},"Phase 4: Upgrade nodes")," in the troubleshooting guide."),(0,n.kt)("hr",null),(0,n.kt)("h3",{id:"4-an-upgrade-is-stuck-in-upgrading-the-first-node-job-was-active-longer-than-the-specified-deadline"},"4. An upgrade is stuck in upgrading the first node: Job was active longer than the specified deadline"),(0,n.kt)("p",null,"An upgrade fails, as shown in the screenshot below:"),(0,n.kt)("p",null,(0,n.kt)("img",{src:a(27667).Z,width:"1140",height:"918"})),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Related issue:",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/harvester/harvester/issues/2894"},"[BUG] Upgrade stuck in upgrading first node: Job was active longer than specified deadline")))),(0,n.kt)("li",{parentName:"ul"},"Workaround:",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/harvester/harvester/issues/2894#issuecomment-1274069690"},"https://github.com/harvester/harvester/issues/2894#issuecomment-1274069690"))))),(0,n.kt)("hr",null),(0,n.kt)("h3",{id:"5-an-upgrade-is-stuck-in-the-pre-drained-state"},"5. An upgrade is stuck in the Pre-drained state"),(0,n.kt)("p",null,'You might see an upgrade is stuck in the "pre-drained" state:'),(0,n.kt)("p",null,(0,n.kt)("img",{src:a(60077).Z,width:"1130",height:"530"})),(0,n.kt)("p",null,"This could be caused by a misconfigured PDB. To check if that's the case, perform the following steps:"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Assume the stuck node is ",(0,n.kt)("inlineCode",{parentName:"p"},"harvester-node-1"),".")),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Check the ",(0,n.kt)("inlineCode",{parentName:"p"},"instance-manager-e")," or ",(0,n.kt)("inlineCode",{parentName:"p"},"instance-manager-r")," pod names on the stuck node:"),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre"},"$ kubectl get pods -n longhorn-system --field-selector spec.nodeName=harvester-node-1 | grep instance-manager\ninstance-manager-r-d4ed2788          1/1     Running   0              3d8h\n")),(0,n.kt)("p",{parentName:"li"},"The output above shows that the ",(0,n.kt)("inlineCode",{parentName:"p"},"instance-manager-r-d4ed2788")," pod is on the node. ")),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Check Rancher logs and verify that the ",(0,n.kt)("inlineCode",{parentName:"p"},"instance-manager-e")," or ",(0,n.kt)("inlineCode",{parentName:"p"},"instance-manager-r")," pod can't be drained:"),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre"},'$ kubectl logs deployment/rancher -n cattle-system\n...\n2023-03-28T17:10:52.199575910Z 2023/03/28 17:10:52 [INFO] [planner] rkecluster fleet-local/local: waiting: draining etcd node(s) custom-4f8cb698b24a,custom-a0f714579def\n2023-03-28T17:10:55.034453029Z evicting pod longhorn-system/instance-manager-r-d4ed2788\n2023-03-28T17:10:55.080933607Z error when evicting pods/"instance-manager-r-d4ed2788" -n "longhorn-system" (will retry after 5s): Cannot evict pod as it would violate the pod\'s disruption budget.\n'))),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Run the command to check if there is a PDB associated with the stuck node:"),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre"},'$ kubectl get pdb -n longhorn-system -o yaml | yq \'.items[] | select(.spec.selector.matchLabels."longhorn.io/node"=="harvester-node-1") | .metadata.name\'\ninstance-manager-r-466e3c7f\n'))),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Check the owner of the instance manager to this PDB:"),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre"},"$ kubectl get instancemanager instance-manager-r-466e3c7f -n longhorn-system -o yaml | yq -e '.spec.nodeID'\nharvester-node-2\n")),(0,n.kt)("p",{parentName:"li"},"If the output doesn't match the stuck node (in this example output, ",(0,n.kt)("inlineCode",{parentName:"p"},"harvester-node-2")," doesn't match the stuck node ",(0,n.kt)("inlineCode",{parentName:"p"},"harvester-node-1"),"), then we can conclude this issue happens.")),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Before applying the workaround, check if all volumes are healthy:"),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre"},"kubectl get volumes -n longhorn-system -o yaml | yq '.items[] | select(.status.state == \"attached\")| .status.robustness'\n")),(0,n.kt)("p",{parentName:"li"},"The output should all be ",(0,n.kt)("inlineCode",{parentName:"p"},"healthy"),". If this is not the case, you might want to uncordon nodes to make the volume healthy again.")),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},"Remove the misconfigured PDB:"),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre"},"kubectl delete pdb instance-manager-r-466e3c7f -n longhorn-system\n")))),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Related issue:",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/harvester/harvester/issues/3730"},"[BUG] 3 Node AirGapped Cluster Upgrade Stuck v1.1.0->v1.1.2-rc4"))))),(0,n.kt)("hr",null))}c.isMDXComponent=!0},27667:(e,t,a)=>{a.d(t,{Z:()=>r});const r=a.p+"assets/images/2894-deadline-8fbfd53960ef87f904f6a893a4a0bfcd.png"},60077:(e,t,a)=>{a.d(t,{Z:()=>r});const r=a.p+"assets/images/3730-stuck-c48392f50cb65bcfe1e0e823d6696e3e.png"},71178:(e,t,a)=>{a.d(t,{Z:()=>r});const r=a.p+"assets/images/3839-error-6dc815a5f5edbb60c92750f1a65c48d6.png"},46479:(e,t,a)=>{a.d(t,{Z:()=>r});const r=a.p+"assets/images/4246-pending-replica-27cff1f4b47113bcb0a5fc207ad54e61.png"},41273:(e,t,a)=>{a.d(t,{Z:()=>r});const r=a.p+"assets/images/4246-pending-7c411c93a62433d215b54e21f938f3ef.png"},16380:(e,t,a)=>{a.d(t,{Z:()=>r});const r=a.p+"assets/images/4246-upgrade-repo-pod-9a796ae8bfcd218dc2484f47841d8b44.png"}}]);